/*
 * @name = Net-ISP
 * @desc = Net-ISPé¢æ¿
 * @author = Keywos
----------------------------------------
[Rule]
DOMAIN-SUFFIX,ip-api.com,PROXY

[Panel]
Net-ISP = script-name=Net-ISP,update-interval=43200

[Script]
Net-ISP = type=generic,timeout=8,script-path=https://raw.githubusercontent.com/Centralmatrix3/Matrix-io/master/Surge/Scripts/Net-ISP.Js
----------------------------------------
*/

let e,t={updata:{"è¯´æ˜":"å¯åœ¨æŒä¹…åŒ–æ•°æ®ä¸­æ›´æ”¹æ˜¯å¦åœ¨é¢æ¿ä¸­æ˜¾ç¤ºè¿™æ ·å¯ä»¥ç›´æ¥ä½¿ç”¨è¿œç¨‹é“¾æ¥ï¼Œä¸ç”¨æ”¾åœ¨æœ¬åœ°å³å¯ä¿®æ”¹ï¼Œè¾“é”™äº†ä¼šè‡ªåŠ¨æ¢å¤é»˜è®¤é‡æ–°è¿è¡Œåé‡å†™JSONé‡Œçš„å‚æ•°å³å¯","cnTimeout ä¸ºå…¥å£è¶…æ—¶æ—¶é—´":"usTimeout ä¸ºè½åœ°è¶…æ—¶æ—¶é—´","icons ä¸ºå›¾æ ‡":"icolor ä¸ºé¢œè‰²","hideIP ä¸º":"æ˜¯å¦éšè—IP","å¼€ä¸º":!0,"å…³ä¸º":!1},version:20230922.1,"ä»¥ä¸‹ä¸º":"é…ç½®å‚æ•°",icons:"globe.asia.australia",icolor:"#6699FF",GPT:!1,hideIP:!0,cnTimeout:1e3,usTimeout:3e3,nw:!0},o=!0,i=!1,s=!1;function c(e,t){return e.split(" ",t).join(" ").replace(/\.|\,|com|\u4e2d\u56fd/g,"")}function r(e){return e.replace(/(\w{1,4})(\.|\:)(\w{1,4}|\*)$/,((e,t,o,n)=>`${"âˆ—".repeat(t.length)}.${"âˆ—".repeat(n.length)}`))}async function l(e="/v1/requests/recent",t="GET",o=null){return new Promise(((n,i)=>{$httpAPI(t,e,o,(e=>{n(e)}))}))}function a(e){const t=e.toUpperCase().split("").map((e=>127397+e.charCodeAt()));return String.fromCodePoint(...t).replace(/ğŸ‡¹ğŸ‡¼/g,"ğŸ‡¨ğŸ‡³")}async function u(e,t){let o=1;const i=new Promise(((i,s)=>{const c=async r=>{try{const o=await Promise.race([new Promise(((t,o)=>{let n=Date.now();$httpClient.get({url:e},((e,i,s)=>{if(e)o(e);else{let e=Date.now()-n;switch(i.status){case 200:let o=i.headers["Content-Type"];switch(!0){case o.includes("application/json"):let n=JSON.parse(s);n.tk=e,t(n);break;case o.includes("text/html"):t("text/html");break;case o.includes("text/plain"):let i=s.split("\n").reduce(((t,o)=>{let[n,i]=o.split("=");return t[n]=i,t.tk=e,t}),{});t(i);break;case o.includes("image/svg+xml"):t("image/svg+xml");break;default:t("æœªçŸ¥")}break;case 204:t({tk:e});break;case 429:console.log("æ¬¡æ•°è¿‡å¤š"),t("æ¬¡æ•°è¿‡å¤š");break;case 404:console.log("404"),t("404");break;default:t("nokey")}}}))})),new Promise(((e,o)=>{setTimeout((()=>o(new Error("timeout"))),t)}))]);o?i(o):(i("è¶…æ—¶"),s(new Error(n.message)))}catch(e){r<1?(o++,c(r+1)):(i("æ£€æµ‹å¤±è´¥, é‡è¯•æ¬¡æ•°"+o),s(e))}};c(0)}));return i}(async()=>{try{try{let n=$persistentStore.read("KeyNetisp"),c=$environment;e=n?JSON.parse(n):t;try{!(c["surge-build"]<2969)&&(s=!0),e.version<t.version&&(e.cnTimeout=t.cnTimeout,e.usTimeout=t.usTimeout,e.version=t.version,console.log("å‡çº§: V"+t.version),$persistentStore.write(JSON.stringify(e,"",2),"KeyNetisp"))}catch(e){o=!1}!e.nw&&o&&e.version===t.version&&"boolean"==typeof e.hideIP&&"boolean"==typeof e.GPT&&"string"==typeof e.icons&&"string"==typeof e.icolor&&"number"==typeof e.cnTimeout&&"number"==typeof e.usTimeout&&"object"==typeof e.updata||(console.log("æ— æ•°æ®æˆ–æ•°æ®é”™è¯¯æˆ–æ›´æ–°,æ¢å¤é»˜è®¤"),delete t.nw,i=!0,e=t)}catch(o){console.log("æ— æ•°æ®æˆ–æ•°æ®é”™è¯¯æˆ–æ›´æ–°,æ¢å¤é»˜è®¤"),e=t,i=!0}i&&$persistentStore.write(JSON.stringify(t,"",2),"KeyNetisp");let n=e.GPT,c=e.icons,p=e.icolor,m=e.hideIP,d=e.cnTimeout,g=e.usTimeout,y="",f="",P="èŠ‚ç‚¹ä¿¡æ¯æŸ¥è¯¢",h="ä»£ç†é“¾",w="",N="",T="",k="";const v=await u("http://ip-api.com/json/?lang=zh-CN",g);if("success"===v.status&&s){console.log("ipapi"+JSON.stringify(v,null,2));let{country:e,countryCode:t,regionName:o,query:n,city:i,org:s,isp:c,as:l,tk:u}=v;y=n,m&&(n=r(n)),e===i&&(i=""),w=" \t"+(a(t)+e+" "+i)+"\nè½åœ°IP: \t"+n+": "+u+"ms\nè½åœ°ISP: \t"+c+"\nè½åœ°ASN: \t"+l}else console.log("ild"+JSON.stringify(v)),w="";if(n){const e=await u("http://chat.openai.com/cdn-cgi/trace",g),t=["CN","TW","HK","IR","KP","RU","VE","BY"];if("string"!=typeof e){let{loc:o,tk:n,warp:i,ip:s}=e,c=t.indexOf(o),r="";r=-1==c?"GPT: "+o+" âœ“":"GPT: "+o+" Ã—",(i="plus")&&(i="Plus"),P=r+"       âŸ     Priv: "+i+"   "+n+"ms"}else P="ChatGPT "+e}const S=await l();let $,b="";let I=S.requests.slice(0,6).filter((e=>/ip-api\.com/.test(e.URL)));if(I.length>0&&s){const e=I[0];k=": "+e.policyName,/\(Proxy\)/.test(e.remoteAddress)?($=e.remoteAddress.replace(" (Proxy)",""),h=""):($="Noip",b="ä»£ç†é“¾åœ°åŒº:")}else $="Noip";if($environment["surge-build"]<2969)throw new Error("");let C=!1,O="spe",J=!1,x="edtest";if(isv6=!1,cn=!0,"Noip"===$?C=!0:/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test($)?J=!0:/^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test($)&&(isv6=!0),$==y)cn=!1,b="ç›´è¿èŠ‚ç‚¹:";else{if(""===b&&(b="è½åœ°åœ°åŒº:"),!C||J){const e=await u(`https://api-v3.${O}${x}.cn/ip?ip=${$}`,d);if(0===e.code&&"ä¸­å›½"===e.data.country){let{province:t,isp:o,city:n,countryCode:i}=e.data,s=e.tk;console.log("ik"+JSON.stringify(e,null,2)),cn=!0,m&&($=r($)),N="å…¥å£å›½å®¶: \t"+a(i)+t+" "+n+"\nå…¥å£IP: \t"+$+": "+s+"ms\nå…¥å£ISP: \t"+o+h+"\n---------------------\n"}else cn=!1,console.log("ik"+JSON.stringify(e)),N="å…¥å£IPA Failed\n"}if((!C||isv6)&&!cn){const e=await u(`http://ip-api.com/json/${$}?lang=zh-CN`,g);if("success"===e.status){console.log("iai"+JSON.stringify(e,null,2));let{countryCode:t,country:o,city:n,tk:i,isp:s}=e;m&&($=r($));let c=o+" "+n;N="å…¥å£å›½å®¶: \t"+a(t)+c+"\nå…¥å£IP: \t"+$+": "+i+"ms\nå…¥å£ISP: \t"+s+h+"\n---------------------\n"}else console.log("iai"+JSON.stringify(e)),N="å…¥å£IPB Failed\n"}}$done({title:P+k,content:T+f+N+b+w,icon:c,"icon-color":p})}catch(e){console.log(e.message),$done({title:outgpt+nodeNames,content:local+outbli+outik+outld+zl,icon:icons,"icon-color":icolor})}})();
